<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RAVENS ACCESS v4.0</title>
    
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;0,900;1,400&display=swap" rel="stylesheet">

    <style>
        /* === ESTILOS NATIVOS RAVENS === */
        :root {
            --guinda: #800020;
            --verde: #36b04b;
            --rojo: #b80000;
            --azul: #004080;
            --negro: #000000;
            --gris-dark: #121212;
            --gris-claro: #1c1c1e;
            --borde: #333;
            --dorado: #eab308;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--negro);
            color: white;
            font-family: 'Lato', sans-serif;
            margin: 0; padding: 0;
            display: flex; justify-content: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #app-frame {
            width: 100%; max-width: 480px;
            background: #050505;
            display: flex; flex-direction: column;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            min-height: 100vh;
        }

        header {
            height: 65px; background: rgba(18, 18, 18, 0.95);
            border-bottom: 1px solid var(--borde);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 100; backdrop-filter: blur(10px);
            position: sticky; top: 0;
        }

        .brand { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .logo-box { width: 36px; height: 36px; background: var(--guinda); border: 1px solid white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .brand-text h1 { margin: 0; font-size: 1.2rem; font-style: italic; font-weight: 900; line-height: 1; }
        .brand-text p { margin: 0; font-size: 0.6rem; color: #aaa; letter-spacing: 1px; font-weight: 700; }
        .status-led { width: 8px; height: 8px; background: var(--verde); border-radius: 50%; box-shadow: 0 0 5px var(--verde); }

        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
        .screen { display: none; animation: slideUp 0.25s ease-out; }
        .screen.active { display: block; }

        h2.title { font-size: 1.6rem; font-weight: 900; font-style: italic; text-transform: uppercase; margin-bottom: 5px; color: white; }
        p.subtitle { color: #888; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 25px; }

        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-card {
            background: var(--gris-claro); border: 1px solid var(--borde);
            border-radius: 18px; height: 140px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 12px; cursor: pointer; transition: 0.1s;
        }
        .menu-card:active { transform: scale(0.97); border-color: var(--dorado); }
        .menu-card.full { grid-column: span 2; height: 100px; flex-direction: row; gap: 20px; }
        .card-icon { font-size: 2.2rem; color: var(--dorado); }
        .card-text { font-size: 0.8rem; font-weight: 800; text-transform: uppercase; color: #ddd; }

        .btn-back { background: none; border: none; color: #777; font-weight: 700; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; margin-bottom: 15px; cursor: pointer; padding: 10px 0; }
        
        .action-list { display: flex; flex-direction: column; gap: 15px; }
        .btn-action {
            background: var(--gris-claro); border: 1px solid var(--borde);
            padding: 22px; border-radius: 14px;
            display: flex; align-items: center; justify-content: space-between;
            color: white; font-weight: 700; text-transform: uppercase; font-size: 0.95rem; cursor: pointer;
        }
        .btn-action.primary { background: var(--guinda); }
        .btn-action.blue { background: var(--azul); }

        .form-box { background: var(--gris-claro); padding: 25px; border-radius: 20px; border: 1px solid var(--borde); }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.7rem; color: #888; font-weight: 800; margin-bottom: 6px; margin-left: 5px; }
        .ravens-input {
            width: 100%; background: black; border: 1px solid #444;
            color: white; padding: 14px; border-radius: 12px;
            font-size: 1rem; outline: none;
        }

        .btn-save {
            width: 100%; padding: 18px; border: none; border-radius: 12px;
            font-weight: 900; font-size: 1rem; text-transform: uppercase;
            margin-top: 10px; cursor: pointer; color: white; background: var(--verde);
        }
        .btn-save:disabled { background: #333; color: #666; cursor: not-allowed; }

        /* MODAL SELECTOR RESIDENTE */
        .modal-residente {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 200; display: none; flex-direction: column; padding: 20px;
        }
        .modal-residente.active { display: flex; }
        .selector-box { background: #1a1a1a; padding: 20px; border-radius: 25px; border: 1px solid var(--guinda); margin-top: auto; margin-bottom: auto; }

        /* FIRMA Y FOTO */
        .photo-area { position: relative; height: 140px; border: 2px dashed #444; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-direction: column; overflow: hidden; }
        .photo-preview { position: absolute; inset: 0; background-size: cover; background-position: center; z-index: 10; }
        .signature-wrapper { height: 160px; background: white; border-radius: 12px; overflow: hidden; touch-action: none; }
        #sig-canvas { width: 100%; height: 100%; }

        /* FEEDBACK SCREEN */
        .feedback-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70vh; text-align: center; }
        .feedback-icon { font-size: 5rem; margin-bottom: 20px; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="app-frame">
    <header>
        <div class="brand" onclick="navigate('INICIO')">
            <div class="logo-box">R</div>
            <div class="brand-text">
                <h1>RAVENS</h1>
                <p>ACCESS SYSTEM</p>
            </div>
        </div>
        <div class="status-led"></div>
    </header>

    <main id="viewport"></main>
</div>

<div id="modal-selector" class="modal-residente">
    <div class="selector-box">
        <h3 style="text-align: center; margin-bottom: 20px;">SELECCIONAR RESIDENTE</h3>
        <div class="input-group">
            <label>TORRE</label>
            <select id="sel-torre" class="ravens-input" onchange="updateDeptos()"></select>
        </div>
        <div class="input-group">
            <label>DEPARTAMENTO</label>
            <select id="sel-depto" class="ravens-input" onchange="updateResidentes()"></select>
        </div>
        <div class="input-group">
            <label>RESIDENTE</label>
            <select id="sel-nombre" class="ravens-input"></select>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-save" style="background: var(--rojo);" onclick="closeResidenteModal()">CANCELAR</button>
            <button class="btn-save" onclick="confirmResidente()">ACEPTAR</button>
        </div>
    </div>
</div>

<script>
    /* =========================================
       1. CONFIGURACI√ìN Y DATOS
       ========================================= */
    const API = {
        VISITA: "https://prod-13.mexicocentral.logic.azure.com:443/workflows/b9c72600a3b64e03b0e34f8ee930ca61/triggers/Recibir_Aviso_GET/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FRecibir_Aviso_GET%2Frun&sv=1.0&sig=JsqhAlXVbSjZ5QY-cXMGaAoX5ANtjjAoVM38gGYAG64"
    };

    const STATE = {
        colBaserFiltrada: [
            { Torre: "A", Departamento: "101", Nombre: "Juan Perez", N√∫mero: "525512345678" },
            { Torre: "A", Departamento: "102", Nombre: "Ana Gomez", N√∫mero: "525587654321" },
            { Torre: "B", Departamento: "201", Nombre: "Carlos Ruiz", N√∫mero: "525522334455" }
        ],
        colvisitaOrdenada: [],
        varNumeroSeleccionado1: "",
        VarNombreSeleccionado1: "",
        varProcesandoAA1: false,
        varmostrarpaloma1: false,
        photos: {}
    };

    /* =========================================
       2. DEFINICI√ìN DE PANTALLAS
       ========================================= */
    const SCREENS = {
        'INICIO': `
            <div class="screen active">
                <h2 class="title">PANEL DE CONTROL</h2>
                <p class="subtitle">SELECCIONE M√ìDULO</p>
                <div class="grid-menu">
                    <div class="menu-card" onclick="navigate('A1')"><i class="fas fa-users card-icon"></i><span class="card-text">VISITAS</span></div>
                    <div class="menu-card" onclick="navigate('B1')"><i class="fas fa-box-open card-icon"></i><span class="card-text">PAQUETER√çA</span></div>
                    <div class="menu-card" onclick="navigate('D1')"><i class="fas fa-tools card-icon"></i><span class="card-text">PROVEEDORES</span></div>
                    <div class="menu-card" onclick="navigate('E1')"><i class="fas fa-qrcode card-icon"></i><span class="card-text">ACCESO QR</span></div>
                    <div class="menu-card full" onclick="navigate('F1')"><i class="fas fa-user-shield card-icon"></i><span class="card-text">PERSONAL INTERNO</span></div>
                </div>
            </div>
        `,
        'A1': `
            <div class="screen active">
                <button class="btn-back" onclick="navigate('INICIO')"><i class="fas fa-chevron-left"></i> MEN√ö PRINCIPAL</button>
                <h2 class="title">VISITAS</h2>
                <div class="action-list">
                    <div class="btn-action primary" onclick="navigate('AA1')"><span>‚ûï REGISTRAR VISITA</span></div>
                    <div class="btn-action" onclick="navigate('AA2')"><span>üìã VER BIT√ÅCORA</span></div>
                </div>
            </div>
        `,
        'AA1': `
            <div class="screen active">
                <button class="btn-back" onclick="navigate('A1')"><i class="fas fa-chevron-left"></i> VOLVER</button>
                <h2 class="title" style="color:var(--guinda)">NUEVA VISITA</h2>
                <div class="form-box">
                    <div class="input-group"><label>NOMBRE VISITANTE</label><input type="text" id="aa1-nombre" class="ravens-input"></div>
                    <div class="row">
                        <div class="input-group"><label>TORRE</label><input type="text" id="aa1-torre" class="ravens-input" readonly></div>
                        <div class="input-group"><label>DEPTO</label><input type="text" id="aa1-depto" class="ravens-input" readonly></div>
                    </div>
                    <button class="btn-save" style="background:var(--azul); margin-bottom:15px;" onclick="openResidenteModal()">
                        <i class="fas fa-search"></i> SELECCIONAR RESIDENTE
                    </button>
                    <div class="input-group">
                        <label>RESIDENTE ASIGNADO</label>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <input type="text" id="aa1-residente" class="ravens-input" style="background:#080808; color:#888;" readonly>
                            <span id="check-paloma" style="display:none; color:var(--verde); font-size:1.5rem;">‚úÖ</span>
                        </div>
                    </div>
                    <div class="input-group"><label>PLACA</label><input type="text" id="aa1-placa" class="ravens-input"></div>
                    <div class="input-group"><label>MOTIVO</label><input type="text" id="aa1-motivo" class="ravens-input"></div>
                    <button class="btn-save" id="btn-aa1-save" onclick="logicAA1()">GUARDAR Y NOTIFICAR</button>
                </div>
            </div>
        `,
        'AA2': `<div class="screen active"><button class="btn-back" onclick="navigate('A1')">VOLVER</button><h2 class="title">BIT√ÅCORA</h2><div id="list-aa2"></div></div>`,
        'EAV': `<div class="feedback-screen"><i class="fas fa-check-circle feedback-icon" style="color:var(--verde)"></i><h2 class="title" style="color:var(--verde)">AVISO ENVIADO</h2><p>Registro correcto</p></div>`,
        'QF': `<div class="feedback-screen"><i class="fas fa-times-circle feedback-icon" style="color:var(--rojo)"></i><h2 class="title" style="color:var(--rojo)">ERROR</h2><p>Llene los campos obligatorios</p></div>`,
        'B1': `<div class="screen active"><button class="btn-back" onclick="navigate('INICIO')">VOLVER</button><h2 class="title">PAQUETER√çA</h2><div class="action-list"><div class="btn-action primary" onclick="navigate('BA1')">RECIBIR</div><div class="btn-action blue" onclick="navigate('BB1')">ENTREGAR</div></div></div>`,
        'BA1': `<div class="screen active"><button class="btn-back" onclick="navigate('B1')">VOLVER</button><h2 class="title">RECIBIR</h2><div class="form-box"><div class="input-group"><label>PAQUETE PARA</label><input type="text" id="ba1-nom" class="ravens-input"></div><button class="btn-save" onclick="navigate('EAV')">GUARDAR</button></div></div>`,
        'BB1': `<div class="screen active"><button class="btn-back" onclick="navigate('B1')">VOLVER</button><h2 class="title">ENTREGA</h2><div class="form-box"><div class="signature-wrapper"><canvas id="sig-canvas"></canvas></div><button class="btn-save" style="background:var(--azul)" onclick="navigate('EAV')">FIRMAR</button></div></div>`,
        'D1': `<div class="screen active"><button class="btn-back" onclick="navigate('INICIO')">VOLVER</button><h2 class="title">PROVEEDORES</h2><div class="form-box"><input type="text" placeholder="Empresa" class="ravens-input"><button class="btn-save" onclick="navigate('EAV')">REGISTRAR</button></div></div>`,
        'F1': `<div class="screen active"><button class="btn-back" onclick="navigate('INICIO')">VOLVER</button><h2 class="title">PERSONAL</h2><div class="form-box"><input type="text" placeholder="ID" class="ravens-input"><button class="btn-save" onclick="navigate('EAV')">REGISTRAR</button></div></div>`,
        'E1': `<div class="screen active"><button class="btn-back" onclick="navigate('INICIO')">VOLVER</button><h2 class="title">ESC√ÅNER QR</h2><div class="qr-frame"><div id="qr-reader"></div></div></div>`
    };

    /* =========================================
       3. L√ìGICA DE NEGOCIO (POWER APPS ENGINE)
       ========================================= */
    function navigate(screen) {
        document.getElementById('viewport').innerHTML = SCREENS[screen] || SCREENS['INICIO'];
        if(screen === 'AA1') {
            document.getElementById('aa1-residente').value = STATE.VarNombreSeleccionado1;
            document.getElementById('check-paloma').style.display = STATE.varmostrarpaloma1 ? 'block' : 'none';
        }
        if(screen === 'AA2') renderVisitas();
        if(screen === 'EAV' || screen === 'QF') setTimeout(() => navigate('INICIO'), 3000);
        window.scrollTo(0,0);
    }

    // SELECTOR DE RESIDENTES (AA1 LOGIC)
    function openResidenteModal() {
        const torres = [...new Set(STATE.colBaserFiltrada.map(i => i.Torre))].sort();
        const selTorre = document.getElementById('sel-torre');
        selTorre.innerHTML = torres.map(t => `<option value="${t}">${t}</option>`).join('');
        updateDeptos();
        document.getElementById('modal-selector').classList.add('active');
    }

    function updateDeptos() {
        const torre = document.getElementById('sel-torre').value;
        const deptos = STATE.colBaserFiltrada.filter(i => i.Torre === torre).map(i => i.Departamento);
        document.getElementById('sel-depto').innerHTML = deptos.map(d => `<option value="${d}">${d}</option>`).join('');
        updateResidentes();
    }

    function updateResidentes() {
        const torre = document.getElementById('sel-torre').value;
        const depto = document.getElementById('sel-depto').value;
        const residents = STATE.colBaserFiltrada.filter(i => i.Torre === torre && i.Departamento === depto).map(i => i.Nombre);
        document.getElementById('sel-nombre').innerHTML = residents.map(n => `<option value="${n}">${n}</option>`).join('');
    }

    function confirmResidente() {
        const torre = document.getElementById('sel-torre').value;
        const depto = document.getElementById('sel-depto').value;
        const nombre = document.getElementById('sel-nombre').value;
        const item = STATE.colBaserFiltrada.find(i => i.Nombre === nombre);

        STATE.VarNombreSeleccionado1 = nombre;
        STATE.varNumeroSeleccionado1 = item.N√∫mero;
        STATE.varmostrarpaloma1 = true;

        document.getElementById('aa1-torre').value = torre;
        document.getElementById('aa1-depto').value = depto;
        document.getElementById('aa1-residente').value = nombre;
        document.getElementById('check-paloma').style.display = 'block';
        closeResidenteModal();
    }

    function closeResidenteModal() { document.getElementById('modal-selector').classList.remove('active'); }

    // GUARDAR VISITA (AA1 OnSuccess REPLICATED)
    async function logicAA1() {
        const nombreVis = document.getElementById('aa1-nombre').value;
        const motivo = document.getElementById('aa1-motivo').value;

        if(!nombreVis || !motivo || !STATE.VarNombreSeleccionado1) {
            return navigate('QF');
        }

        document.getElementById('btn-aa1-save').disabled = true;
        
        // Simulaci√≥n de LastSubmit
        const newID = Date.now();
        const registro = {
            ID: newID,
            Nombre: nombreVis,
            N√∫mero: STATE.varNumeroSeleccionado1,
            Torre: document.getElementById('aa1-torre').value,
            Departamento: document.getElementById('aa1-depto').value,
            Motivo: motivo,
            Condominio: "RAVENS_MAIN",
            Hora: new Date().toLocaleTimeString('es-MX', {hour: '2-digit', minute:'2-digit'})
        };

        STATE.colvisitaOrdenada.unshift(registro);

        // DISPARO DE URL FANTASMA (Exactamente como en YAML)
        const url = `${API.VISITA}&Nombre=${encodeURIComponent(registro.Nombre)}&Telefono=${encodeURIComponent(registro.N√∫mero)}&Torre=${encodeURIComponent(registro.Torre)}&Depto=${encodeURIComponent(registro.Departamento)}&Motivo=${encodeURIComponent(registro.Motivo)}&Condominio=${encodeURIComponent(registro.Condominio)}&Hora=${encodeURIComponent(registro.Hora)}&Ignorar=${Date.now()}&ID_Item=${registro.ID}&Tipo_Lista=VISITA`;

        try {
            await fetch(url, { method: 'POST' });
            STATE.varmostrarpaloma1 = false;
            STATE.VarNombreSeleccionado1 = "";
            navigate('EAV');
        } catch(e) {
            navigate('QF');
        }
    }

    function renderVisitas() {
        const container = document.getElementById('list-aa2');
        container.innerHTML = STATE.colvisitaOrdenada.map(v => `
            <div class="log-item ok">
                <div class="log-header"><span>${v.Nombre}</span><span>${v.Hora}</span></div>
                <div class="log-sub">Visita a: ${v.Torre}-${v.Departamento}</div>
            </div>
        `).join('');
    }

    window.onload = () => navigate('INICIO');

</script>
</body>
</html>
